<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceSync Estacionamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container { max-width: 1200px; }
        .card { margin-bottom: 20px; }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .status-conciliado { background-color: #28a745; color: white; }
        .status-pendente { background-color: #ffc107; color: black; }
        .status-erro { background-color: #dc3545; color: white; }
        .value-difference { color: #dc3545; }
        .payment-method-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .status-bar {
            height: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">FinanceSync Estacionamento</a>
            <div class="d-flex">
                <button class="btn btn-light me-2">
                    <i class="bi bi-bell"></i>
                </button>
                <button class="btn btn-light">
                    <i class="bi bi-gear"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <h1 class="mb-4">FinanceSync Estacionamento</h1>

        <!-- Upload de Arquivos -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Upload de Arquivos</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" class="row g-3">
                    <div class="col-md-4">
                        <label for="fileType" class="form-label">Tipo de Arquivo</label>
                        <select class="form-select" id="fileType" required>
                            <option value="">Selecione...</option>
                            <option value="credit-card">Cartão de Crédito</option>
                            <option value="cnab">CNAB (Boleto)</option>
                            <option value="pix">PIX</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="file" class="form-label">Arquivo</label>
                        <input type="file" class="form-control" id="file" required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-upload me-2"></i>Upload
                        </button>
                    </div>
                </form>
                
                <!-- Alerta de resultado -->
                <div id="uploadResult" class="alert mt-3" style="display: none;"></div>
                
                <!-- Resumo do upload -->
                <div id="uploadSummary" class="mt-3" style="display: none;">
                    <h6>Resumo do Upload</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>Arquivo:</th>
                                    <td id="summaryFilename"></td>
                                </tr>
                                <tr>
                                    <th>Pagamentos Processados:</th>
                                    <td id="summaryPayments"></td>
                                </tr>
                                <tr>
                                    <th>Valor Total:</th>
                                    <td id="summaryTotal"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <h2 class="mb-4">Conciliação Financeira</h2>

            <!-- Resumo Diário -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Resumo Diário</h5>
                        <input type="date" class="form-control" style="width: 200px;" id="reconciliationDate">
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted">Esperado</small>
                            <h3 id="expectedAmount">R$ 0,00</h3>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Recebido</small>
                            <h3 id="receivedAmount">R$ 0,00</h3>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Diferença</small>
                            <h3 id="differenceAmount" class="value-difference">R$ 0,00</h3>
                        </div>
                        <div class="col-md-3 text-end">
                            <span class="status-badge status-pendente mb-2" id="reconciliationStatus">Pendente</span>
                            <button class="btn btn-primary" id="reconcileButton">Conciliar Agora</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Métodos de Pagamento -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Métodos de Pagamento</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <canvas id="paymentMethodsChart"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <div class="payment-method-item">
                                        <span>Mastercard</span>
                                        <strong id="mastercardTotal">R$ 0,00</strong>
                                    </div>
                                    <div class="payment-method-item">
                                        <span>Visa</span>
                                        <strong id="visaTotal">R$ 0,00</strong>
                                    </div>
                                    <div class="payment-method-item">
                                        <span>PIX</span>
                                        <strong id="pixTotal">R$ 0,00</strong>
                                    </div>
                                    <div class="payment-method-item">
                                        <span>Boleto</span>
                                        <strong id="boletoTotal">R$ 0,00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status de Conciliação -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Status de Conciliação</h5>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Conciliados</span>
                                    <span id="conciliadosCount">0 (0%)</span>
                                </div>
                                <div class="status-bar bg-success" style="width: 0%"></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Pendentes</span>
                                    <span id="pendentesCount">0 (0%)</span>
                                </div>
                                <div class="status-bar bg-warning" style="width: 0%"></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Com Erro</span>
                                    <span id="errosCount">0 (0%)</span>
                                </div>
                                <div class="status-bar bg-danger" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transações -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">Transações</h5>
                        <button class="btn btn-outline-primary" id="exportButton">
                            Exportar
                        </button>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" placeholder="Buscar transações..." id="searchInput">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="statusFilter">
                                <option value="todos">Todos</option>
                                <option value="conciliado">Conciliado</option>
                                <option value="pendente">Pendente</option>
                                <option value="erro">Com Erro</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Estacionamento</th>
                                    <th>Método</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <!-- Preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração do gráfico de métodos de pagamento
        const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
        const paymentMethodsChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Mastercard', 'Visa', 'PIX', 'Boleto'],
                datasets: [{
                    data: [45000, 38000, 65000, 27000],
                    backgroundColor: [
                        '#dc3545',
                        '#0d6efd',
                        '#198754',
                        '#ffc107'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Função para formatar valores em reais
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Atualizar valores do resumo
        document.getElementById('expectedAmount').textContent = formatCurrency(175000);
        document.getElementById('receivedAmount').textContent = formatCurrency(173250);
        document.getElementById('differenceAmount').textContent = formatCurrency(-1750);

        // Atualizar totais por método de pagamento
        document.getElementById('mastercardTotal').textContent = formatCurrency(45000);
        document.getElementById('visaTotal').textContent = formatCurrency(38000);
        document.getElementById('pixTotal').textContent = formatCurrency(65000);
        document.getElementById('boletoTotal').textContent = formatCurrency(27000);

        // Atualizar contadores de status
        document.getElementById('conciliadosCount').textContent = '3 (50%)';
        document.querySelector('.status-bar.bg-success').style.width = '50%';
        document.getElementById('pendentesCount').textContent = '2 (33%)';
        document.querySelector('.status-bar.bg-warning').style.width = '33%';
        document.getElementById('errosCount').textContent = '1 (17%)';
        document.querySelector('.status-bar.bg-danger').style.width = '17%';

        // Dados de exemplo para a tabela de transações
        const transactions = [
            { id: 'TX123456', date: '15/05/2023', location: 'Estacionamento Centro', method: 'Mastercard', amount: 5250.75, status: 'conciliado' },
            { id: 'TX123457', date: '15/05/2023', location: 'Estacionamento Shopping', method: 'Visa', amount: 3780.25, status: 'conciliado' },
            { id: 'TX123458', date: '15/05/2023', location: 'Estacionamento Aeroporto', method: 'PIX', amount: 8920.50, status: 'pendente' },
            { id: 'TX123459', date: '15/05/2023', location: 'Estacionamento Hospital', method: 'Boleto', amount: 2450.00, status: 'erro' },
            { id: 'TX123460', date: '15/05/2023', location: 'Estacionamento Centro', method: 'PIX', amount: 6750.25, status: 'pendente' },
            { id: 'TX123461', date: '15/05/2023', location: 'Estacionamento Shopping', method: 'Mastercard', amount: 4320.75, status: 'conciliado' }
        ];

        // Função para renderizar a tabela de transações
        function renderTransactions(filteredTransactions = transactions) {
            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = '';
            
            filteredTransactions.forEach(transaction => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.location}</td>
                    <td>${transaction.method}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td><span class="status-badge status-${transaction.status}">${transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1)}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Inicializar tabela
        renderTransactions();

        // Evento de busca
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filtered = transactions.filter(transaction => {
                const matchesSearch = Object.values(transaction).some(value => 
                    value.toString().toLowerCase().includes(searchTerm)
                );
                const matchesStatus = statusFilter === 'todos' || transaction.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            renderTransactions(filtered);
        });

        // Evento de filtro por status
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            const statusFilter = e.target.value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = transactions.filter(transaction => {
                const matchesSearch = Object.values(transaction).some(value => 
                    value.toString().toLowerCase().includes(searchTerm)
                );
                const matchesStatus = statusFilter === 'todos' || transaction.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            renderTransactions(filtered);
        });

        // Evento de exportação
        document.getElementById('exportButton').addEventListener('click', () => {
            // Implementar lógica de exportação
            alert('Funcionalidade de exportação em desenvolvimento');
        });

        // Evento de conciliação
        document.getElementById('reconcileButton').addEventListener('click', () => {
            // Implementar lógica de conciliação
            alert('Funcionalidade de conciliação em desenvolvimento');
        });

        // Evento de mudança de data
        document.getElementById('reconciliationDate').addEventListener('change', (e) => {
            // Implementar lógica de mudança de data
            alert('Funcionalidade de mudança de data em desenvolvimento');
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileType = document.getElementById('fileType').value;
            const file = document.getElementById('file').files[0];
            const resultDiv = document.getElementById('uploadResult');
            const summaryDiv = document.getElementById('uploadSummary');
            
            if (!file) {
                showAlert('Selecione um arquivo para upload.', 'danger');
                return;
            }
            
            // Validar extensões por tipo de arquivo
            const validExtensions = {
                'credit-card': ['.csv', '.txt', '.tsv'],
                'cnab': ['.txt'],
                'pix': ['.xlsx']
            };
            
            const fileExt = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!validExtensions[fileType].includes(fileExt)) {
                showAlert(`Extensão de arquivo inválida para ${fileType}. Use: ${validExtensions[fileType].join(', ')}`, 'danger');
                return;
            }
            
            // Preparar formulário
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // Mostrar loading
                showAlert('Processando arquivo...', 'info');
                
                // Enviar arquivo
                const response = await fetch(`/upload/${fileType}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message, 'success');
                    
                    // Mostrar resumo
                    document.getElementById('summaryFilename').textContent = result.filename;
                    document.getElementById('summaryPayments').textContent = result.processed_payments;
                    document.getElementById('summaryTotal').textContent = 
                        new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })
                            .format(result.total_value || 0);
                    
                    summaryDiv.style.display = 'block';
                } else {
                    showAlert(result.detail || 'Erro ao processar arquivo', 'danger');
                    summaryDiv.style.display = 'none';
                }
            } catch (error) {
                showAlert('Erro ao enviar arquivo', 'danger');
                summaryDiv.style.display = 'none';
            }
        });
        
        function showAlert(message, type) {
            const alertDiv = document.getElementById('uploadResult');
            alertDiv.className = `alert alert-${type} mt-3`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
        }
        
        // Atualizar label do input file com nome do arquivo selecionado
        document.getElementById('file').addEventListener('change', function() {
            const fileName = this.files[0]?.name || 'Nenhum arquivo selecionado';
            this.nextElementSibling?.remove(); // Remove label anterior se existir
            const label = document.createElement('div');
            label.className = 'form-text';
            label.textContent = fileName;
            this.parentElement.appendChild(label);
        });
    </script>
</body>
</html> 